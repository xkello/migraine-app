{% extends "tracker/base.html" %}

{% block title %}{% if is_edit %}Edit Log{% else %}Log your day{% endif %}{% endblock %}

{% block content %}
<div class="mx-auto" style="max-width: 600px;">
  <h2 class="h4 mb-4 fw-bold">{% if is_edit %}Edit entry for {{ form.instance.date }}{% else %}Log your day{% endif %}</h2>

  <form method="post" class="card-glass shadow-lg">
    {% csrf_token %}

    <div class="row g-4">
        <!-- Date -->
        <div class="col-12">
          <label class="form-label-small d-block mb-1">Date of Log</label>
          {{ form.date }}
          <div class="form-help">Which day are you reporting for?</div>
        </div>

        <!-- Life metrics -->
        <div class="col-6">
          <label class="form-label-small d-block mb-1">Sleep (hours)</label>
          {{ form.sleep_hours }}
        </div>
        <div class="col-6">
          <label class="form-label-small d-block mb-1">Activity (min)</label>
          {{ form.physical_activity_minutes }}
        </div>

        <div class="col-6">
          <label class="form-label-small d-block mb-1">Stress lv (1–5)</label>
          {{ form.stress_level }}
        </div>
        <div class="col-6">
          <label class="form-label-small d-block mb-1">Caffeine (mg)</label>
          {{ form.caffeine_mg }}
        </div>

        <div class="col-12">
            <hr class="border-secondary opacity-25">
        </div>

        <!-- Migraine section -->
        <div class="col-12">
            <div class="form-check form-switch bg-dark bg-opacity-25 p-3 rounded-3 border border-secondary border-opacity-10 d-flex align-items-center">
              {{ form.had_migraine }}
              <label class="form-check-label fw-bold ms-3 mt-1" for="{{ form.had_migraine.id_for_label }}">
                Did you have a migraine?
              </label>
            </div>
        </div>

        <div id="migraine-fields-container" class="col-12" style="transition: opacity 0.3s ease;">
            <div class="row g-4">
                <div class="col-6">
                    <label class="form-label-small d-block mb-1">Intensity (0–10)</label>
                    {{ form.migraine_intensity }}
                </div>
                <div class="col-6">
                    <label class="form-label-small d-block mb-1">Duration (hours)</label>
                    {{ form.migraine_duration_hours }}
                </div>
                <div class="col-12">
                    <label class="form-label-small d-block mb-1">Medication taken</label>
                    {{ form.meds_taken }}
                </div>
            </div>
        </div>

        <div class="col-12">
            <label class="form-label-small d-block mb-1">Additional Notes</label>
            {{ form.notes }}
        </div>

        <div class="col-12 mt-4">
            <button type="submit" class="btn btn-accent btn-lg w-100 shadow-sm py-2 fw-bold">
                <i class="bi bi-save me-2"></i>{% if is_edit %}Update Log{% else %}Save Log{% endif %}
            </button>

            {% if is_edit %}
              <a href="{% url 'tracker:delete_log' log_pk %}" class="btn btn-outline-danger w-100 mt-3 py-2 border-0">
                <i class="bi bi-trash me-2"></i>Delete entry
              </a>
            {% endif %}
        </div>
    </div>
  </form>

  <div class="mt-4 p-3 text-soft small text-center opacity-75">
    <i class="bi bi-info-circle me-1"></i>
    Weather data will be automatically synced based on your city.
  </div>
</div>

<style>
    .log-input:disabled {
        opacity: 0.3;
        background-color: #0d1218 !important;
        cursor: not-allowed;
        border-color: rgba(187, 225, 250, 0.05) !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const checkbox = document.getElementById("{{ form.had_migraine.id_for_label }}");
    const intensity = document.getElementById("{{ form.migraine_intensity.id_for_label }}");
    const duration = document.getElementById("{{ form.migraine_duration_hours.id_for_label }}");
    const meds = document.getElementById("{{ form.meds_taken.id_for_label }}");
    const container = document.getElementById("migraine-fields-container");

    function updateMigraineFields() {
      const isChecked = checkbox.checked;
      [intensity, duration, meds].forEach(field => {
        if (field) {
          field.disabled = !isChecked;
          if (!isChecked) {
              field.required = false;
          }
        }
      });

      if (container) {
          container.style.opacity = isChecked ? "1" : "0.4";
          container.style.pointerEvents = isChecked ? "auto" : "none";
      }
    }

    if (checkbox) {
      checkbox.addEventListener("change", updateMigraineFields);
      updateMigraineFields();
    }
  });
</script>
{% endblock %}
