{% extends "tracker/base.html" %}

{% block title %}Migraine Tracker{% endblock %}

{% block content %}
  <h2 class="h4 mb-3">Welcome back, {{ user_name }}</h2>

  {% if not has_data %}
    <div class="card-glass p-3 mb-3">
      <p class="mb-0 text-soft">
        You don't have any logs yet. Tap the <strong>+</strong> button in the bottom bar
        to add your first day. Once you have a few entries, your graphs will appear here.
      </p>
    </div>
  {% else %}

    <!-- HEALTH SECTION -->
    <p class="mb-1 text-soft small">Your health data</p>
    <!-- Sleep -->
    <div class="card-glass mb-3">
      <div class="d-flex justify-content-between align-items-center px-3 pt-2">
        <span class="small fw-semibold">Sleep (hours)</span>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 nav-prev" data-chart="sleepChart">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 nav-next" data-chart="sleepChart">▶</button>
          </div>
      </div>
      <div id="graph-sleep" class="p-3 pt-1">
        <canvas id="sleepChart" height="140"></canvas>
      </div>
    </div>

    <!-- Activity -->
    <div class="card-glass mb-3">
      <div class="d-flex justify-content-between align-items-center px-3 pt-2">
        <span class="small fw-semibold">Physical activity (minutes)</span>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 nav-prev" data-chart="activityChart">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 nav-next" data-chart="activityChart">▶</button>
          </div>
      </div>
      <div id="graph-activity" class="p-3 pt-1">
        <canvas id="activityChart" height="140"></canvas>
      </div>
    </div>

    <!-- Stress -->
    <div class="card-glass mb-3">
      <div class="d-flex justify-content-between align-items-center px-3 pt-2">
        <span class="small fw-semibold">Stress level (1–5)</span>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 nav-prev" data-chart="stressChart">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 nav-next" data-chart="stressChart">▶</button>
          </div>
      </div>
      <div id="graph-stress" class="p-3 pt-1">
        <canvas id="stressChart" height="140"></canvas>
      </div>
    </div>

    <!-- Caffeine -->
    <div class="card-glass mb-3">
      <div class="d-flex justify-content-between align-items-center px-3 pt-2">
        <span class="small fw-semibold">Caffeine (mg)</span>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 nav-prev" data-chart="caffeineChart">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 nav-next" data-chart="caffeineChart">▶</button>
          </div>
      </div>
      <div id="graph-caffeine" class="p-3 pt-1">
        <canvas id="caffeineChart" height="140"></canvas>
      </div>
    </div>

    <!-- MIGRAINE SECTION -->
    <p class="mb-1 text-soft small">Your migraine data</p>
    <!-- MIGRAINE INTENSITY -->
    <div class="card-glass mb-3">
      <div class="d-flex justify-content-between align-items-center px-3 pt-2">
        <span class="small fw-semibold">Intensity, duration & occurrences</span>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 nav-prev" data-chart="migraineIntensityChart">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 nav-next" data-chart="migraineIntensityChart">▶</button>
          </div>
      </div>
      <div id="graph-intensity" class="p-3 pt-1">
        <canvas id="migraineIntensityChart" height="180"></canvas>
      </div>
    </div>

    <!-- MIGRAINE DURATION -->
    <div class="card-glass mb-3">
      <div class="d-flex justify-content-between align-items-center px-3 pt-2">
        <span class="small fw-semibold">Intensity, duration & occurrences</span>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 nav-prev" data-chart="migraineDurationChart">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 nav-next" data-chart="migraineDurationChart">▶</button>
          </div>
      </div>
      <div id="graph-duration" class="p-3 pt-1">
        <canvas id="migraineDurationChart" height="180"></canvas>
      </div>
    </div>

    <!-- MIGRAINE OCCURRENCES -->
    <div class="card-glass mb-3">
      <div class="d-flex justify-content-between align-items-center px-3 pt-2">
        <span class="small fw-semibold">Intensity, duration & occurrences</span>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 nav-prev" data-chart="migraineOccurrenceChart">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 nav-next" data-chart="migraineOccurrenceChart">▶</button>
          </div>
      </div>
      <div id="graph-occurrence" class="p-3 pt-1">
        <canvas id="migraineOccurrenceChart" height="180"></canvas>
      </div>
    </div>

    <!-- WEATHER SECTION -->
    <p class="mb-1 text-soft small">Weather data</p>

    <!-- Pressure -->
    <div class="card-glass mb-3">
      <div class="d-flex justify-content-between align-items-center px-3 pt-2">
        <span class="small fw-semibold">Pressure (hPa)</span>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 weather-prev">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 weather-next">▶</button>
          </div>
      </div>
      <div id="graph-pressure" class="p-3 pt-1">
        <canvas id="weatherPressureChart" height="140"></canvas>
      </div>
    </div>

    <!-- Temperature -->
    <div class="card-glass mb-3">
      <div class="d-flex justify-content-between align-items-center px-3 pt-2">
        <span class="small fw-semibold">Temperature (°C)</span>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 weather-prev">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 weather-next">▶</button>
          </div>
      </div>
      <div id="graph-temp" class="p-3 pt-1">
        <canvas id="weatherTempChart" height="140"></canvas>
      </div>
    </div>

    <!-- Humidity -->
    <div class="card-glass mb-3">
      <div class="d-flex justify-content-between align-items-center px-3 pt-2">
        <span class="small fw-semibold">Humidity (%)</span>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 weather-prev">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 weather-next">▶</button>
          </div>
      </div>
      <div id="graph-humidity" class="p-3 pt-1">
        <canvas id="weatherHumidityChart" height="140"></canvas>
      </div>
    </div>


  {% endif %}
{% endblock %}

{% block extra_js %}
<script>
  // Data from Django (already valid JSON strings)
  const labels = {{ labels_json|default:"[]"|safe }};
  const sleepData = {{ sleep_json|default:"[]"|safe }};
  const activityData = {{ activity_json|default:"[]"|safe }};
  const stressData = {{ stress_json|default:"[]"|safe }};
  const caffeineData = {{ caffeine_json|default:"[]"|safe }};

  const migraineIntensityData = {{ migraine_intensity_json|default:"[]"|safe }};
  const migraineDurationData = {{ migraine_duration_json|default:"[]"|safe }};
  const hadMigraineFlags = {{ had_migraine_flags_json|default:"[]"|safe }};

  const weatherLabelsISO = {{ weather_labels_json|default:"[]"|safe }};
  const pressureData = {{ weather_pressure_json|default:"[]"|safe }};
  const tempData = {{ weather_temp_json|default:"[]"|safe }};
  const humidityData = {{ weather_humidity_json|default:"[]"|safe }};

  function fmtLabel(isoDate) {
      // isoDate: "2025-12-28"
      const [y,m,d] = isoDate.split("-");
      return `${d}.${m}`;
  }

  function sliceWindow(arr, start, size) {
      return arr.slice(start, start + size);
  }

  document.addEventListener("DOMContentLoaded", function () {
    if (!labels || !labels.length || typeof Chart === "undefined") {
      return;
    }

    // Per-graph toggle buttons
    document.querySelectorAll(".toggle-graph").forEach(btn => {
      btn.addEventListener("click", function () {
        const targetSelector = this.getAttribute("data-target");
        const body = document.querySelector(targetSelector);
        if (!body) return;

        const icon = this.querySelector("i");
        if (body.classList.contains("d-none")) {
          body.classList.remove("d-none");
          if (icon) {
            icon.classList.remove("bi-chevron-down");
            icon.classList.add("bi-chevron-up");
          }
        } else {
          body.classList.add("d-none");
          if (icon) {
            icon.classList.remove("bi-chevron-up");
            icon.classList.add("bi-chevron-down");
          }
        }
      });
    });

    const fullLabels = labels.map(fmtLabel);

    // ---- helpers ----
    function clampStart(start, size, len) {
      if (len <= size) return 0;
      return Math.max(0, Math.min(start, len - size));
    }

    function getWindow(cfg) {
      const len = (cfg.labels || []).length;
      const start = clampStart(cfg.start || 0, cfg.size, len);
      return {
        labels: sliceWindow(cfg.labels, start, cfg.size),
        data: sliceWindow(cfg.data, start, cfg.size),
        start
      };
    }

    function updateSingleChart(chart, cfg) {
      if (!chart || !cfg || !Array.isArray(cfg.data) || !Array.isArray(cfg.labels)) return;

      const win = getWindow(cfg);
      cfg.start = win.start;

      chart.data.labels = win.labels;
      chart.data.datasets[0].data = win.data;
      chart.update();
    }

    const charts = {}; // id -> Chart instance

    // series config (IMPORTANT: use JS variables, not template tags)
    const series = {
      sleepChart:    { labels: fullLabels, data: sleepData,    size: 7, start: Math.max(0, fullLabels.length - 7) },
      activityChart: { labels: fullLabels, data: activityData, size: 7, start: Math.max(0, fullLabels.length - 7) },
      stressChart:   { labels: fullLabels, data: stressData,   size: 7, start: Math.max(0, fullLabels.length - 7) },
      caffeineChart: { labels: fullLabels, data: caffeineData, size: 7, start: Math.max(0, fullLabels.length - 7) },
    };

    // migraine series (7-day paging like health)
    series.migraineIntensityChart = {
      labels: fullLabels,
      data: migraineIntensityData,
      size: 7,
      start: Math.max(0, fullLabels.length - 7)
    };

    series.migraineDurationChart = {
      labels: fullLabels,
      data: migraineDurationData,
      size: 7,
      start: Math.max(0, fullLabels.length - 7)
    };

    series.migraineOccurrenceChart = {
      labels: fullLabels,
      data: hadMigraineFlags,
      size: 7,
      start: Math.max(0, fullLabels.length - 7)
    };

    createLineChart("migraineIntensityChart", "Intensity (0–10)", "#BBE1FA", series.migraineIntensityChart);
    createLineChart("migraineDurationChart", "Duration (hours)", "#3282B8", series.migraineDurationChart);
    createBarChart("migraineOccurrenceChart", "Had migraine (0/1)", "#0F4C75", series.migraineOccurrenceChart);

    const weatherLabels = weatherLabelsISO.map(fmtLabel);

    // fixed window: 7 past incl today + 3 future = 10 points
    const weatherGroup = {
      labels: weatherLabels,
      size: 10,      // 7 past + 3 future window look
      step: 3,       // move by 3 days each click
      start: Math.max(0, weatherLabels.length - 10), // start at "latest window"
      pressure: pressureData,
      temp: tempData,
      humidity: humidityData,
    };

    document.querySelectorAll(".weather-prev").forEach(btn => {
      btn.addEventListener("click", () => {
        weatherGroup.start -= weatherGroup.step;
        updateWeatherCharts();
      });
    });

    document.querySelectorAll(".weather-next").forEach(btn => {
      btn.addEventListener("click", () => {
        weatherGroup.start += weatherGroup.step;
        updateWeatherCharts();
      });
    });

    function createWeatherLine(canvasId, label, color, labelsArr, dataArr) {
      const el = document.getElementById(canvasId);
      if (!el) return;

      charts[canvasId] = new Chart(el, {
        type: "line",
        data: {
          labels: labelsArr,
          datasets: [{
            label,
            data: dataArr,
            borderColor: color,
            backgroundColor: "transparent",
            tension: 0.35,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: "#BBE1FA" } } },
          scales: {
            x: { ticks: { color: "#BBE1FA" }, grid: { color: "rgba(187,225,250,0.08)" } },
            y: { ticks: { color: "#BBE1FA" }, grid: { color: "rgba(187,225,250,0.08)" } }
          }
        }
      });
    }

    function getWeatherWindow() {
      const len = weatherGroup.labels.length;
      const start = clampStart(weatherGroup.start, weatherGroup.size, len);

      return {
        start,
        labels: sliceWindow(weatherGroup.labels, start, weatherGroup.size),
        pressure: sliceWindow(weatherGroup.pressure, start, weatherGroup.size),
        temp: sliceWindow(weatherGroup.temp, start, weatherGroup.size),
        humidity: sliceWindow(weatherGroup.humidity, start, weatherGroup.size),
      };
    }

    function updateWeatherCharts() {
      const w = getWeatherWindow();
      weatherGroup.start = w.start;

      updateSingleChart(charts["weatherPressureChart"], { labels: weatherGroup.labels, data: weatherGroup.pressure, size: weatherGroup.size, start: weatherGroup.start });
      updateSingleChart(charts["weatherTempChart"], { labels: weatherGroup.labels, data: weatherGroup.temp, size: weatherGroup.size, start: weatherGroup.start });
      updateSingleChart(charts["weatherHumidityChart"], { labels: weatherGroup.labels, data: weatherGroup.humidity, size: weatherGroup.size, start: weatherGroup.start });
    }

    const w0 = getWeatherWindow();
    weatherGroup.start = w0.start;

    createWeatherLine("weatherPressureChart", "Pressure (hPa)", "#3282B8", w0.labels, w0.pressure);
    createWeatherLine("weatherTempChart", "Temperature (°C)", "#BBE1FA", w0.labels, w0.temp);
    createWeatherLine("weatherHumidityChart", "Humidity (%)", "#0F4C75", w0.labels, w0.humidity);



    // create charts (initialize with window slice, not full data)
    function createLineChart(canvasId, label, color, cfg) {
      const el = document.getElementById(canvasId);
      if (!el) return;

      const win = getWindow(cfg);

      charts[canvasId] = new Chart(el, {
        type: "line",
        data: {
          labels: win.labels,
          datasets: [{
            label: label,
            data: win.data,
            borderColor: color,
            backgroundColor: "transparent",
            tension: 0.35,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: "#BBE1FA" } }
          },
          scales: {
            x: { ticks: { color: "#BBE1FA" }, grid: { color: "rgba(187,225,250,0.08)" } },
            y: { ticks: { color: "#BBE1FA" }, grid: { color: "rgba(187,225,250,0.08)" } }
          }
        }
      });
    }

    function createBarChart(canvasId, label, color, cfg) {
      const el = document.getElementById(canvasId);
      if (!el) return;

      const win = getWindow(cfg);

      charts[canvasId] = new Chart(el, {
        type: "bar",
        data: {
          labels: win.labels,
          datasets: [{
            label: label,
            data: win.data,
            borderColor: color,
            backgroundColor: color
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: "#BBE1FA" } }
          },
          scales: {
            x: { ticks: { color: "#BBE1FA" }, grid: { color: "rgba(187,225,250,0.08)" } },
            y: { ticks: { color: "#BBE1FA" }, grid: { color: "rgba(187,225,250,0.08)" } }
          }
        }
      });
    }

    // create your health charts
    createLineChart("sleepChart", "Sleep (hours)", "#3282B8", series.sleepChart);
    createBarChart("activityChart", "Activity (minutes)", "#0F4C75", series.activityChart);
    createLineChart("stressChart", "Stress (1–5)", "#BBE1FA", series.stressChart);
    createBarChart("caffeineChart", "Caffeine (mg)", "#3282B8", series.caffeineChart);

    // paging buttons (safe)
    document.querySelectorAll(".nav-prev").forEach(btn => {
      btn.addEventListener("click", () => {
        const key = btn.dataset.chart;
        const cfg = series[key];
        if (!cfg) return;
        cfg.start = (cfg.start || 0) - cfg.size;
        updateSingleChart(charts[key], cfg);
      });
    });

    document.querySelectorAll(".nav-next").forEach(btn => {
      btn.addEventListener("click", () => {
        const key = btn.dataset.chart;
        const cfg = series[key];
        if (!cfg) return;
        cfg.start = (cfg.start || 0) + cfg.size;
        updateSingleChart(charts[key], cfg);
      });
    });


  });
</script>
{% endblock %}
