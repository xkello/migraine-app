{% extends "tracker/base.html" %}

{% block title %}Migraine Tracker{% endblock %}

{% block content %}
  <h2 class="h4 mb-3">Welcome back, {{ user_name }}</h2>

  <div class="card-glass mb-4 p-3 border-start border-accent border-4">
    <div class="d-flex align-items-center gap-3">
        <div class="flex-grow-1">
            <p class="mb-0 text-soft small text-uppercase fw-bold" style="letter-spacing: 1px;">Your Migraine Risk</p>
            <div class="d-flex align-items-center gap-2">
                <h3 class="h2 mb-0 fw-bold">Low</h3>
                <i class="bi bi-shield-check text-success fs-3"></i>
            </div>
        </div>
    </div>
    <div class="mt-2 small text-soft">
        Why is the risk so low? Your sleep and stress levels have been optimal lately.
    </div>
  </div>

  {% if not has_data %}
    <div class="card-glass mb-3">
      <p class="mb-0 text-soft">
        You don't have any logs yet. Tap the <strong>+</strong> button in the bottom bar
        to add your first day. Once you have a few entries, your graphs will appear here.
      </p>
    </div>
  {% else %}

    <!-- HEALTH SECTION -->
    <p class="mb-1 text-soft small">Your health data</p>
    <!-- Sleep -->
    <div class="card-glass">
      <div class="d-flex align-items-center justify-content-center gap-3 px-3 pt-2 flex-nowrap">
        <span class="small fw-semibold-no-margin text-nowrap">Sleep (hours)</span>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 nav-prev" data-chart="sleepChart">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 nav-next" data-chart="sleepChart">▶</button>
        </div>
      </div>
      <div id="graph-sleep" class="p-3 pt-1">
        <canvas id="sleepChart" height="140"></canvas>
      </div>
    </div>

    <!-- Activity -->
    <div class="card-glass">
      <div class="d-flex align-items-center justify-content-center gap-3 px-3 pt-2 flex-nowrap">
        <span class="small fw-semibold-no-margin text-nowrap">Physical activity (minutes)</span>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 nav-prev" data-chart="activityChart">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 nav-next" data-chart="activityChart">▶</button>
        </div>
      </div>
      <div id="graph-activity" class="p-3 pt-1">
        <canvas id="activityChart" height="140"></canvas>
      </div>
    </div>

    <!-- Stress -->
    <div class="card-glass">
      <div class="d-flex align-items-center justify-content-center gap-3 px-3 pt-2 flex-nowrap">
        <span class="small fw-semibold-no-margin text-nowrap">Stress level (1 – 5)</span>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 nav-prev" data-chart="stressChart">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 nav-next" data-chart="stressChart">▶</button>
        </div>
      </div>
      <div id="graph-stress" class="p-3 pt-1">
        <canvas id="stressChart" height="140"></canvas>
      </div>
    </div>

    <!-- Caffeine -->
    <div class="card-glass">
      <div class="d-flex align-items-center justify-content-center gap-3 px-3 pt-2 flex-nowrap">
        <span class="small fw-semibold-no-margin text-nowrap">Caffeine (mg)</span>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 nav-prev" data-chart="caffeineChart">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 nav-next" data-chart="caffeineChart">▶</button>
        </div>
      </div>
      <div id="graph-caffeine" class="p-3 pt-1">
        <canvas id="caffeineChart" height="140"></canvas>
      </div>
    </div>

    <!-- MIGRAINE SECTION -->
    <p class="mb-1 text-soft small">Your migraine data</p>
    <!-- MIGRAINE INTENSITY -->
    <div class="card-glass">
      <div class="d-flex align-items-center justify-content-center gap-3 px-3 pt-2 flex-nowrap">
        <span class="small fw-semibold-no-margin text-nowrap">Intensity (0-10)</span>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 nav-prev" data-chart="migraineIntensityChart">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 nav-next" data-chart="migraineIntensityChart">▶</button>
        </div>
      </div>
      <div id="graph-intensity" class="p-3 pt-1">
        <canvas id="migraineIntensityChart" height="180"></canvas>
      </div>
    </div>

    <!-- MIGRAINE DURATION -->
    <div class="card-glass">
      <div class="d-flex align-items-center justify-content-center gap-3 px-3 pt-2 flex-nowrap">
        <span class="small fw-semibold-no-margin text-nowrap">Duration (hours)</span>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 nav-prev" data-chart="migraineDurationChart">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 nav-next" data-chart="migraineDurationChart">▶</button>
        </div>
      </div>
      <div id="graph-duration" class="p-3 pt-1">
        <canvas id="migraineDurationChart" height="180"></canvas>
      </div>
    </div>

    <!-- MIGRAINE OCCURRENCES -->
    <div class="card-glass">
      <div class="d-flex align-items-center justify-content-center gap-3 px-3 pt-2 flex-nowrap">
        <span class="small fw-semibold-no-margin text-nowrap">Occurrences (0/1)</span>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 nav-prev" data-chart="migraineOccurrenceChart">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 nav-next" data-chart="migraineOccurrenceChart">▶</button>
        </div>
      </div>
      <div id="graph-occurrence" class="p-3 pt-1">
        <canvas id="migraineOccurrenceChart" height="180"></canvas>
      </div>
    </div>

    <!-- WEATHER SECTION -->
    <p class="mb-1 text-soft small">Weather data</p>

    <!-- Pressure -->
    <div class="card-glass">
      <div class="d-flex align-items-center justify-content-center gap-3 px-3 pt-2 flex-nowrap">
        <span class="small fw-semibold-no-margin text-nowrap">Pressure (hPa)</span>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 weather-prev">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 weather-next">▶</button>
        </div>
      </div>
      <div id="graph-pressure" class="p-3 pt-1">
        <canvas id="weatherPressureChart" height="140"></canvas>
      </div>
    </div>

    <!-- Temperature -->
    <div class="card-glass">
      <div class="d-flex align-items-center justify-content-center gap-3 px-3 pt-2 flex-nowrap">
        <span class="small fw-semibold-no-margin text-nowrap">Temperature (°C)</span>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 weather-prev">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 weather-next">▶</button>
        </div>
      </div>
      <div id="graph-temp" class="p-3 pt-1">
        <canvas id="weatherTempChart" height="140"></canvas>
      </div>
    </div>

    <!-- Humidity -->
    <div class="card-glass">
      <div class="d-flex align-items-center justify-content-center gap-3 px-3 pt-2 flex-nowrap">
        <span class="small fw-semibold-no-margin text-nowrap">Humidity (%)</span>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-light p-0 weather-prev">◀</button>
            <button class="btn btn-sm btn-link text-light p-0 weather-next">▶</button>
        </div>
      </div>
      <div id="graph-humidity" class="p-3 pt-1">
        <canvas id="weatherHumidityChart" height="140"></canvas>
      </div>
    </div>


  {% endif %}
{% endblock %}

{% block extra_js %}
<script>
  // Data from Django
  const labels = {{ labels_json|default:"[]"|safe }};
  const sleepData = {{ sleep_json|default:"[]"|safe }};
  const activityData = {{ activity_json|default:"[]"|safe }};
  const stressData = {{ stress_json|default:"[]"|safe }};
  const caffeineData = {{ caffeine_json|default:"[]"|safe }};

  const migraineIntensityData = {{ migraine_intensity_json|default:"[]"|safe }};
  const migraineDurationData = {{ migraine_duration_json|default:"[]"|safe }};
  const hadMigraineFlags = {{ had_migraine_flags_json|default:"[]"|safe }};

  const weatherLabelsISO = {{ weather_labels_json|default:"[]"|safe }};
  const pressureData = {{ weather_pressure_json|default:"[]"|safe }};
  const tempData = {{ weather_temp_json|default:"[]"|safe }};
  const humidityData = {{ weather_humidity_json|default:"[]"|safe }};

  window.charts = {}; // id -> Chart instance
  const fullLabels = labels.map(fmtLabel);

  // series config
  window.series = {
    sleepChart:    { labels: fullLabels, data: sleepData,    size: 6, start: Math.max(0, fullLabels.length - 6) },
    activityChart: { labels: fullLabels, data: activityData, size: 6, start: Math.max(0, fullLabels.length - 6) },
    stressChart:   { labels: fullLabels, data: stressData,   size: 6, start: Math.max(0, fullLabels.length - 6) },
    caffeineChart: { labels: fullLabels, data: caffeineData, size: 6, start: Math.max(0, fullLabels.length - 6) },
    migraineIntensityChart: { labels: fullLabels, data: migraineIntensityData, size: 6, start: Math.max(0, fullLabels.length - 6) },
    migraineDurationChart:  { labels: fullLabels, data: migraineDurationData,  size: 6, start: Math.max(0, fullLabels.length - 6) },
    migraineOccurrenceChart: { labels: fullLabels, data: hadMigraineFlags,      size: 6, start: Math.max(0, fullLabels.length - 6) }
  };

  const weatherLabels = weatherLabelsISO.map(fmtLabel);
  window.weatherGroup = {
    labels: weatherLabels,
    size: 10,
    step: 3,
    start: Math.max(0, weatherLabels.length - 10),
    pressure: pressureData,
    temp: tempData,
    humidity: humidityData
  };

  window.updateWeatherCharts = function() {
    const len = weatherGroup.labels.length;
    const start = clampStart(weatherGroup.start, weatherGroup.size, len);
    weatherGroup.start = start;

    const labels = sliceWindow(weatherGroup.labels, start, weatherGroup.size);
    
    const update = (id, data) => {
        const c = charts[id];
        if (!c) return;
        c.data.labels = labels;
        c.data.datasets[0].data = sliceWindow(data, start, weatherGroup.size);
        c.update();
    };

    update("weatherPressureChart", weatherGroup.pressure);
    update("weatherTempChart", weatherGroup.temp);
    update("weatherHumidityChart", weatherGroup.humidity);
  }

  document.addEventListener("DOMContentLoaded", function () {
    if (!labels || !labels.length || typeof Chart === "undefined") return;

    // Initialize Weather
    const w0 = {
        labels: sliceWindow(weatherGroup.labels, weatherGroup.start, weatherGroup.size),
        pressure: sliceWindow(weatherGroup.pressure, weatherGroup.start, weatherGroup.size),
        temp: sliceWindow(weatherGroup.temp, weatherGroup.start, weatherGroup.size),
        humidity: sliceWindow(weatherGroup.humidity, weatherGroup.start, weatherGroup.size)
    };

    createWeatherLine("weatherPressureChart", "Pressure (hPa)", "#3282B8", w0.labels, w0.pressure, weatherGroup.pressure);
    createWeatherLine("weatherTempChart", "Temperature (°C)", "#BBE1FA", w0.labels, w0.temp, weatherGroup.temp);
    createWeatherLine("weatherHumidityChart", "Humidity (%)", "#0F4C75", w0.labels, w0.humidity, weatherGroup.humidity);

    // Initialize Health/Migraine
    createLineChart("sleepChart", "Sleep (hours)", "#3282B8", series.sleepChart);
    createBarChart("activityChart", "Activity (minutes)", "#0F4C75", series.activityChart);
    createLineChart("stressChart", "Stress (1–5)", "#BBE1FA", series.stressChart);
    createBarChart("caffeineChart", "Caffeine (mg)", "#3282B8", series.caffeineChart);
    createLineChart("migraineIntensityChart", "Intensity (0–10)", "#BBE1FA", series.migraineIntensityChart);
    createLineChart("migraineDurationChart", "Duration (hours)", "#3282B8", series.migraineDurationChart);
    createBarChart("migraineOccurrenceChart", "Had migraine (0/1)", "#0F4C75", series.migraineOccurrenceChart);
  });
</script>
{% endblock %}
