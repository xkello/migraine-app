{% extends "tracker/base.html" %}

{% block title %}Profile & Logs{% endblock %}

{% block content %}
<div class="card-glass mb-4">
    <h2 class="h5 mb-3">Settings</h2>
    <form method="post">
        {% csrf_token %}

        <div class="profile-settings-row mb-3">
            <label for="{{ form.city.id_for_label }}" class="form-label-small mb-0">City:</label>

            <div class="profile-city-input">
                {{ form.city }}
            </div>
        </div>

        <div class="profile-settings-row mb-3">
            <div class="form-check form-switch">
                {{ form.show_menstruation }}
                <label class="form-check-label form-label-small" for="{{ form.show_menstruation.id_for_label }}">
                    Show Menstruation Tracking
                </label>
            </div>
        </div>

        <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-accent px-4">Update Settings</button>
        </div>

        {% if form.city.errors %}
        <div class="w-100 mt-1 text-danger small">
            {{ form.city.errors }}
        </div>
        {% endif %}
    </form>
</div>

<h2 class="h4 mb-3">History</h2>

{% for log in logs %}
<div class="card-glass mb-3">
    <div class="log-card-header mb-2 border-bottom border-secondary pb-2">
        <div class="log-card-header-left">
            <h3 class="log-card-date h5 mb-0 fw-bold" style="color: var(--accent-light); padding-left: 0;">
                {{ log.date|date:"D, d.m" }}
            </h3>

            {% if log.had_migraine %}
            <span class="badge bg-danger p-1 small"><i class="bi bi-exclamation-triangle-fill"></i></span>
            {% else %}
            <span class="badge bg-success p-1 small"><i class="bi bi-check-circle-fill"></i></span>
            {% endif %}
        </div>

        <div class="log-card-actions">
            <a href="{% url 'tracker:edit_log' log.pk %}" class="btn-icon btn-icon--md btn-icon--accent" aria-label="Edit log">
                <i class="bi bi-pencil-square"></i>
            </a>
            <a href="{% url 'tracker:delete_log' log.pk %}" class="btn-icon btn-icon--md btn-icon--danger" aria-label="Delete log">
                <i class="bi bi-trash"></i>
            </a>
        </div>
    </div>

    <div class="log-metrics">
        <div class="log-metric">
            <div class="log-metric-label">Sleep</div>
            <div class="log-metric-value">{{ log.sleep_hours }}h</div>
        </div>

        <div class="log-metric">
            <div class="log-metric-label">Activity</div>
            <div class="log-metric-value">{{ log.physical_activity_minutes }}m (lv {{ log.physical_activity_difficulty }})</div>
        </div>

        <div class="log-metric">
            <div class="log-metric-label">Stress</div>
            <div class="log-metric-value">{{ log.stress_level }}/5</div>
        </div>

        <div class="log-metric">
            <div class="log-metric-label">Meals</div>
            <div class="log-metric-value">{{ log.heavy_meals }}</div>
        </div>

        <div class="log-metric">
            <div class="log-metric-label">Hydration</div>
            <div class="log-metric-value">{{ log.hydration_liters }}l</div>
        </div>

        <div class="log-metric">
            <div class="log-metric-label">Alcohol</div>
            <div class="log-metric-value">{{ log.alcohol_consumption }}/5</div>
        </div>

        {% if log.menstruation %}
        <div class="log-metric">
            <div class="log-metric-label">Period</div>
            <div class="log-metric-value text-accent"><i class="bi bi-droplet-fill"></i></div>
        </div>
        {% endif %}

        {% if log.had_migraine %}
        <div class="log-metric is-danger">
            <div class="log-metric-label text-danger-emphasis">Int.</div>
            <div class="log-metric-value text-danger">{{ log.migraine_intensity }}</div>
        </div>

        <div class="log-metric is-danger">
            <div class="log-metric-label text-danger-emphasis">Dur.</div>
            <div class="log-metric-value text-danger">{{ log.migraine_duration_hours }}h</div>
        </div>

        <div class="log-metric">
            <div class="log-metric-label">Medication</div>
            <div class="log-metric-value log-metric-truncate">{{ log.meds_taken|default:"—" }}</div>
        </div>
        {% endif %}

        <div class="log-metric">
            <div class="log-metric-label">Caffeine</div>
            <div class="log-metric-value">{{ log.caffeine_mg }}mg</div>
        </div>
    </div>

    {% if log.weather_temp_c is not None %}
    <div class="mt-2">
        <div class="log-weather">
            <span><i class="bi bi-thermometer-half text-accent"></i> {{ log.weather_temp_c|floatformat:0 }}°</span>
            <span><i class="bi bi-droplets text-accent"></i> {{ log.weather_humidity }}%</span>
            <span><i class="bi bi-speedometer2 text-accent"></i> {{ log.weather_pressure_hpa }}</span>
            <span class="log-weather-desc"><i class="bi bi-cloud-sun text-accent"></i> {{ log.weather_description }}</span>
        </div>
    </div>
    {% endif %}

    {% if log.notes %}
    <div class="mt-2 p-2 bg-dark bg-opacity-50 rounded border-start border-accent border-2">
        <div class="small text-light" style="font-size: 0.8rem;">{{ log.notes }}</div>
    </div>
    {% endif %}
</div>
{% empty %}
<div class="card-glass text-center p-5">
    <i class="bi bi-journal-x display-1 text-soft"></i>
    <p class="mt-3">No logs yet. Start by adding one!</p>
    <a href="{% url 'tracker:log' %}" class="btn btn-accent mt-2">Add Your First Log</a>
</div>
{% endfor %}
{% endblock %}
